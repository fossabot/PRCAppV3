/* 
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

String.prototype.repeat=function(num){return new Array(num+1).join(this)}$.fn.cgbForm=function(options){var info=[];var rset={};var plFunctionText=openGenericText;var changeTextFunction=changeTextfield;var triggerEvent={};var isChangedVar=false;var OriginalRecordSet={};var plOpenId='';var originalFromForm=true;var pkCode=-1;var pkField=-1;var updController;var updFunction='updateDataJsonForm';var retFunction='retrieveGridJsonForm';var refreshAfterUpdate=true;var formPopupControl=true;var gridToSetAfterUpd;if(options!==undefined){if(options.recordset!==undefined){OriginalRecordSet=$.extend({},options.recordset);originalFromForm=false}if(options.recordsetFromForm!==undefined){originalFromForm=options.recordsetFromForm}if(options.grid!==undefined){gridToSetAfterUpd=options.grid}if(options.refreshAfterUpdate!==undefined){refreshAfterUpdate=options.refreshAfterUpdate}if(options.popupControl!==undefined){formPopupControl=options.popupControl}}if(formPopupControl){$("#main_form_div").on("dialogbeforeclose",function(event,ui){return formCloseControl()})}var $selector=$('#'+this.selector);var $inputs=$('#'+this.selector+' :input');start();if(originalFromForm){formToOriginal()}function start(){$inputs.each(function(){var id=$(this).attr('id');makeField(id,OriginalRecordSet)});triggerEvent.info=info;triggerEvent.formSelector=$selector.attr('id')}function makeField(id,recordSet){$input=$('#'+id);info[id]={formated:false};var fieldrecordset=getRecordsetField(id);var mask=$input.attr('mask');if(recordSet!=undefined){fieldrecordset=getRecordsetField(id);if(recordSet[fieldrecordset]!==undefined&&recordSet[fieldrecordset]!==null){$input.val(recordSet[fieldrecordset])}}if(id.substring(0,3)=='dt_'){$input.w2field('date');info[id]={formated:true,type:'D'};$input.change(function(event){changeTextFunction(id)})}if(mask!==undefined){var maskex=mask.split(';');switch(maskex[0]){case'N':var varex=maskex[1].split('.');maxnumber="9".repeat(parseInt(varex[0]))+'.'+"9".repeat(parseInt(varex[1]));$input.css('text-align','right');$input.w2field('float',{precision:parseInt(varex[1]),max:parseFloat(maxnumber),silent:false});info[id]={maxnumber:maxnumber,formated:true,type:maskex[0]};$input.change(function(event){changeTextFunction(id)});break;case'C':case'c':info[id]={formated:true,type:maskex[0]};if(maskex[0]=='C'){$input.css('text-transform','uppercase');info[id].uppercase=true}if(maskex.length==1){maskex[1]=64}$input.attr('maxlength',maskex[1]);$input.change(function(event){changeTextFunction(id)});break;case'I':if(maskex.length==1){maskex[1]=14}maxnumber="9".repeat(parseInt(maskex[1]));$input.css('text-align','right');$input.w2field('int',{max:parseFloat(maxnumber),silent:false});info[id]={maxnumber:maxnumber,formated:true,type:maskex[0]};$input.change(function(event){changeTextFunction(id)});break;case"PK":$input.css('text-align','right');$input.attr('readonly','readonly');info[id]={formated:false,type:maskex[0]};pkField=id;if(recordSet!=undefined){fieldrecordset=getRecordsetField(id);rset['recid']=recordSet[fieldrecordset];pkCode=rset['recid']}break;case't':case'T':info[id]={title:$("label[for='"+id+"']").text(),formated:true,type:maskex[0]};pickListSet(id,function(id){plFunctionText(id)});break;case'PL':if($input.attr('code_field')==undefined){$input.attr('code_field',retCodeField(id));info[retCodeField(id)]={type:'CODEFIELD',formated:false}}info[id]={title:$("label[for='"+id+"']").text(),descfield:id,codefield:$input.attr('code_field'),type:maskex[0],model:$input.attr('model'),relid:$input.attr('relid'),relcode:$input.attr('relcode')};pickListSet(id,function(target){openPicklist(target)});break}}}function retFieldNoForm(field){return field.substring(0,field.length-5)}function retCodeField(field){return'cd'+field.substring(2,field.length)}function openGenericText(id){vlr=$("#"+id).val();basicTextPLOpen({title:info[id].title,text:vlr,plCallBack:function(saved,text){if(saved){$('#'+id).val(text);changeTextfield(id)}}})}function changeTextfield(id){var ev={id:id,fielddata:info[id]};var vlr=$('#'+id).val(),oldvlr=getItem(id);if(info[id].uppercase){vlr=vlr.toUpperCase()}if(info[id].type=='I'||info[id].type=='N'){vlr=parseFloat(vlr);oldvlr=parseFloat(oldvlr)}if(vlr==oldvlr){return}$.extend(ev,$.Event('itemChanging'),triggerEvent,{old:oldvlr,new:vlr});$selector.trigger(ev);if(ev.isDefaultPrevented()){setItem(id,oldvlr);return}setItem(id,vlr);$.extend(ev,$.Event('itemChanged'),triggerEvent,{old:oldvlr,new:vlr});$selector.trigger(ev)}function formCloseControl(){var ev=$.extend($.Event('beforeClose'),triggerEvent);$selector.trigger(ev);if(ev.isDefaultPrevented()){setItem(id,oldvlr);return}if(isChanged()){w2confirm(javaMessages.info_changed_close,javaMessages.confirm,function(btn){if(btn=='Yes'){resetUpdate();unbindHandlersPL();unbindHandlerForm();$.extend(ev,$.Event('onClose'),triggerEvent);$selector.trigger(ev);$("#main_form_div").dialog('close')}});return false}else{return true}}function openPicklist(target){options={model:info[target].model,title:info[target].title,sel_id:getItem(info[target].codefield)};if(info[target].relid!=undefined){options.relation={id:info[target].relcode,idwhere:info[target].relid}}options.plCallBack=afterPickList;plOpenId=target;var ev={id:target,options:options,fielddata:info[target]}$.extend(ev,$.Event('prepicklist'),triggerEvent);$selector.trigger(ev);if(ev.isDefaultPrevented()){return}basicPickListOpen(options)}function afterPickList(id,desc,record){var vlrid=id,oldidvlr=getItem(info[plOpenId].codefield),vlrdesc=desc,olddescvlr=getItem(plOpenId);var ev={id:plOpenId,fielddata:info[plOpenId],record:record,newCode:vlrid,newDesc:vlrdesc,oldCode:oldidvlr,oldDesc:olddescvlr};$.extend(ev,$.Event('pospicklist'),triggerEvent);$selector.trigger(ev);if(ev.isDefaultPrevented()){return}setItem(info[plOpenId].codefield,id);setItem(plOpenId,desc)}function recordsetToForm(recordset){$.each(recordset,function(key,value){if(value!=null){setItem(key+'_form',value)}})}function getRecordsetField(id){return id.substring(0,id.length-5)}function resetUpdate(setOriginal){if(setOriginal==null){setOriginal=true}if(setOriginal){OriginalRecordSet=$.extend({},OriginalRecordSet,rset)}rset={};setItem(pkField,pkCode);isChangedVar=false}function getRecordtSet(){return rset};function getOriginal(){return OriginalRecordSet}function refreshAll(){start()}function refresh(id){makeField(id)}function setItem(id,vlr){isChangedVar=true;$('#'+id).val(vlr);if(id==pkField){pkCode=vlr;rset['recid']=pkCode}else{rset[getRecordsetField(id)]=vlr}if(info[id]!=undefined){if(info[id].formated){refresh(id)}}else{return}}function getItem(id){if(id==pkField){return pkCode}rsetfield=getRecordsetField(id);return rset[rsetfield]||OriginalRecordSet[rsetfield]}function getOriginalItem(id){rsetfield=getRecordsetField(id);return OriginalRecordSet[rsetfield]}function getChanges(){var ret=$.extend({},rset);ret['style']=undefined;console.log(ret);return ret}function setEnabled(id,enabled){if(info[id].type=='PL'){pickListEnable(id,enabled)}else{$('#'+id).prop('disabled',!enabled)}}function formToOriginal(){OriginalRecordSet={};$inputs.each(function(){var id=$(this).attr('id');var value=$(this).val();if(value==undefined||value==""){return true}OriginalRecordSet[getRecordsetField(id)]=value;if(id==pkField){OriginalRecordSet['recid']=value;pkCode=value}if(info[id].type=="PL"){valuecode=$(this).attr('plCode');OriginalRecordSet[info[id].code_field]=valuecode}})}function formToRecordSet(){rset={};$inputs.each(function(){var id=$(this).attr('id');var value=$(this).val();if(value==undefined||value==""){return true}if(id==pkField){rset['recid']=value;pkCode=value}else{rset[getRecordsetField(id)]=value}if(info[id].type=="PL"){valuecode=$(this).attr('plCode');rset[info[id].code_field]=valuecode}isChangedVar=true})};function setModified(id){var value=$(this).val();setItem(id,value)}function isChanged(){return isChangedVar}function setController(contr){updController=contr}function updateForm(){if(!isChanged()){return}ret=getChanges();ev=$.extend({},$.Event('beforeUpdate'),triggerEvent,{recordset:ret});$selector.trigger(ev);if(ev.isDefaultPrevented()){return}w2utils.lock($selector,javaMessages.updating,true);$.post(updController+"/"+updFunction,{"upd":JSON.stringify(ret)},function(data){if(data=="OK"){toastSuccess(javaMessages.update_done);resetUpdate()}else{toastErrorBig(javaMessages.error_upd+data);w2utils.unlock($selector);return}ev=$.extend({},$.Event('afterUpdate'),triggerEvent,{recordset:ret});w2utils.unlock($selector);if(refreshAfterUpdate){retrieveForm(pkCode,true)}},"text")}function retrieveForm(pk,fromUpdate){if(fromUpdate==undefined){fromUpdate=false}ev=$.extend({},$.Event('beforeRetrieve'),triggerEvent,{});$selector.trigger(ev);if(ev.isDefaultPrevented()){return}w2utils.lock($selector,javaMessages.retrieveData,true);$.post(updController+"/"+retFunction+'/'+pk,{},function(data){if(data.logged=="Y"){recordsetToForm(data.resultset[0]);formToOriginal();resetUpdate()}else{sessionTimeOut()}ev=$.extend({},$.Event('afterRetrieve'),triggerEvent,{recordset:data.resultset[0]});w2utils.unlock($selector);$selector.trigger(ev);if(fromUpdate&&gridToSetAfterUpd!==undefined){var orig=getOriginal();if(gridToSetAfterUpd.get(pkCode)==null){gridToSetAfterUpd.add(orig)}else{gridToSetAfterUpd.set(pkCode,orig)}}},"json")}this.refreshAll=refreshAll;this.refresh=refresh;this.setItem=setItem;this.getItem=getItem;this.getOriginalItem=getOriginalItem;this.getChanges=getChanges;this.setEnabled=setEnabled;this.formToOriginal=formToOriginal;this.getRecordtSet=getRecordtSet;this.getOriginal=getOriginal;this.resetUpdate=resetUpdate;this.recordsetToForm=recordsetToForm;this.formToRecordSet=formToRecordSet;this.setController=setController;this.updateForm=updateForm;this.retrieveForm=retrieveForm;return this};
